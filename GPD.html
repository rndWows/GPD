<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dữ liệu từ Google Sheets</title>
    <link rel="stylesheet" href="stylegpd.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
</head>

<body>
    <div id="fui-toast"></div>
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
    </div>
    <div id="content" class="" style="display: none;">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="packing-list-tab" data-bs-toggle="tab"
                    data-bs-target="#packing-list" type="button" role="tab" aria-controls="packing-list"
                    aria-selected="true">Packing List</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dh-tab" data-bs-toggle="tab" data-bs-target="#dh" type="button" role="tab"
                    aria-controls="dh" aria-selected="false">Đơn Hàng</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bg-tab" data-bs-toggle="tab" data-bs-target="#bg" type="button" role="tab"
                    aria-controls="bg" aria-selected="false">Báo Giá</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pnk-tab" data-bs-toggle="tab" data-bs-target="#pnk" type="button"
                    role="tab" aria-controls="pnk" aria-selected="false">PNK</button>
            </li>

        </ul>
        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="packing-list" role="tabpanel" aria-labelledby="packing-list-tab">
                <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2><i class="fas fa-list"></i> packing-list</h2>
                </div>
                <div class="card-body"></div> <table id="packing-list-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;"></table></div>
               
            </div>
            <div class="tab-pane fade" id="dh" role="tabpanel" aria-labelledby="dh-tab">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h2><i class="fas fa-file-invoice"></i> Đơn hàng</h2>
                    </div>
                    <div class="card-body"></div><table id="dh-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;"></table></div>
                
            </div>
            <div class="tab-pane fade" id="bg" role="tabpanel" aria-labelledby="bg-tab">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h2><i class="fas fa-file-invoice"></i> Báo giá</h2>
                    </div>
                    <div class="card-body"></div>
                    <table id="bg-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;"></table></div>
                
            </div>
            <div class="tab-pane fade" id="pnk" role="tabpanel" aria-labelledby="pnk-tab">
                <div class="card">
                    <div class="ccard-header bg-info text-white">
                        <h2><i class="fas fa-warehouse"></i> Kho</h2>
                    </div>
                    <div class="card-body"></div>
                    <table id="pnk-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;"></table></div>
                
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyKqoJs53LTmIMhW9RXHN79hDHur95r6b7tnt4HVaCZYnch-loT6albaQNtSffjyfHY/exec';
        let sheetData = {};

        // Hàm chuyển đổi định dạng ngày
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // Trả về nguyên gốc nếu không phải ngày hợp lệ
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Hàm đệ quy để xử lý tất cả các trường trong một đối tượng
        function processDateFields(obj) {
            for (let key in obj) {
                if (obj[key] && typeof obj[key] === 'object') {
                    // Nếu giá trị là một đối tượng, gọi đệ quy
                    processDateFields(obj[key]);
                } else if (typeof obj[key] === 'string') {
                    // Kiểm tra nếu trường có vẻ như là một ngày
                    const datePattern = /^\d{4}-\d{2}-\d{2}|^\d{4}\/\d{2}\/\d{2}/;
                    if (datePattern.test(obj[key])) {
                        obj[key] = formatDate(obj[key]);
                    }
                }
            }
        }

        // Áp dụng cho sheetData sau khi đã lấy dữ liệu
        function applyDateFormatting() {
            processDateFields(sheetData);
        }

        // Gọi hàm này sau khi đã lấy dữ liệu và gán vào sheetData
        async function fetchData() {
            try {
                document.getElementById('loading-overlay').style.display = 'block';
                document.getElementById('content').style.display = 'none';

                const response = await fetch(API_URL);
                const data = await response.json();

                // Lưu dữ liệu vào đối tượng sheetData
                sheetData = data;

                // Áp dụng định dạng ngày
                applyDateFormatting();

                displayData();

                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                FuiToast.success(`Tải dữ liệu thành công`);
            } catch (error) {
                console.error('Error fetching data:');
                FuiToast.error(`Lỗi tìm nạp dữ liệu`);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function displayData() {
            displayPackingListTable('packing-list-table', sheetData.packingList);
            displayDHTable('dh-table', sheetData.dh);
            displayBGTable('bg-table', sheetData.bg);
            displayPNKTable('pnk-table', sheetData.pnk);
        }

        function displayPackingListTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && Object.keys(data).length > 0) {
                const headers = ['TỜ KHAI', 'INVOICE', 'TÊN NHÀ CUNG CẤP', 'SỐ CONTAINER', 'TÊN GỖ', 'MÃ KIỆN', 'KHỐI LƯỢNG THỰC TẾ', 'SỐ THANH THỰC TẾ', 'CHIỀU DÀI THỰC TẾ', 'CHIỀU RỘNG THỰC TẾ', 'MÃ KIỆN TRÊN PL', 'Chi tiết'];
                const thead = $('<thead>').append($('<tr>').append(headers.map(header => $('<th>').text(header))));
                table.append(thead);

                const tableData = Object.values(data).map(row => {
                    const rowData = headers.slice(0, -1).map(header => row[header] || '');
                    rowData.push('<button class="btn btn-primary btn-sm detail-btn"><i class="fas fa-eye"></i> </button>');
                    return rowData;
                });

                console.log('Processed table data:', tableData);

                if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                    $(`#${tableId}`).DataTable().destroy();
                }

                $(`#${tableId}`).DataTable({
                    data: tableData,
                    columns: headers.map(header => ({ title: header })),
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip', // Thêm các nút xuất dữ liệu
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ]
                });

                $(`#${tableId} tbody`).on('click', '.detail-btn', function () {
                    const rowData = $(`#${tableId}`).DataTable().row($(this).closest('tr')).data();
                    showPackingListDetails(data[rowData[5]]); // Assuming 'MÃ KIỆN' is the 6th column (index 5)
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu'));
                FuiToast.warning(`Không có dữ liệu`);
            }
        }

        function showPackingListDetails(row) {
            // Hiển thị modal với tất cả thông tin của row
            let modalContent = '<div class="modal-header"><h5 class="modal-title">Chi tiết Packing List</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>';
            modalContent += '<div class="modal-body">';
            for (let key in row) {
                modalContent += `<p><strong>${key}:</strong> ${row[key]}</p>`;
            }
            modalContent += '</div>';

            $('#detailModal1 .modal-content').html(modalContent);
            $('#detailModal1').modal('show');
        }

        function displayBGTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && Object.keys(data).length > 0) {
                const headers = [...Object.keys(data[Object.keys(data)[0]]), 'Chi tiết'];
                const thead = $('<thead>').append($('<tr>').append(headers.map(header => $('<th>').text(header))));
                table.append(thead);

                const tbody = $('<tbody>');
                Object.values(data).forEach(row => {
                    const tr = $('<tr>');
                    headers.slice(0, -1).forEach(header => {
                        tr.append($('<td>').text(row[header] || ''));
                    });
                    tr.append($('<td>').html(`
                        <button class="btn btn-primary btn-sm" onclick="showBGDetails('${row['SỐ BÁO GIÁ']}')">
                            <i class="fas fa-eye"></i> 
                        </button>
                    `));
                    tbody.append(tr);
                });
                table.append(tbody);

                $(`#${tableId}`).DataTable({
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip', // Thêm các nút xuất dữ liệu
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ]
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu'));
                FuiToast.warning(`Không có dữ liệu`);
            }
        }

        function showBGDetails(soBaoGia) {
            const bgDetails = sheetData.bgDetail.filter(detail => detail['SỐ BÁO GIÁ'] === soBaoGia);
            let modalContent = `
        <div class="modal-header">
            <h5 class="modal-title">Chi tiết Báo Giá: ${soBaoGia}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
    `;

            if (bgDetails.length > 0) {
                modalContent += '<table id="bgDetailTable" class="fui-table-ui-basic-linh table-wrap" style="width:100%"></table>';
            } else {
                modalContent += '<p>Không có chi tiết cho báo giá này.</p>';
            }

            modalContent += '</div>';

            $('#detailModal .modal-content').html(modalContent);

            if (bgDetails.length > 0) {
                // Khởi tạo DataTable sau khi modal content đã được thêm vào DOM
                $('#bgDetailTable').DataTable({
                    data: bgDetails,
                    columns: Object.keys(bgDetails[0]).map(key => ({ title: key, data: key })),
                    pageLength: 5, // Hiển thị 5 hàng trên mỗi trang
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Tất cả"]], // Tùy chọn số hàng hiển thị
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip', // Thêm các nút xuất dữ liệu
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ]
                });
            }

            $('#detailModal').modal('show');

            // Xử lý sự kiện khi modal được đóng
            $('#detailModal').on('hidden.bs.modal', function (e) {
                if ($.fn.DataTable.isDataTable('#bgDetailTable')) {
                    $('#bgDetailTable').DataTable().destroy();
                }
            });
        }

        function displayDHTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && Object.keys(data).length > 0) {
                const headers = [...Object.keys(data[Object.keys(data)[0]]), 'Chi tiết'];
                const thead = $('<thead>').append($('<tr>').append(headers.map(header => $('<th>').text(header))));
                table.append(thead);

                const tbody = $('<tbody>');
                Object.values(data).forEach(row => {
                    const tr = $('<tr>');
                    headers.slice(0, -1).forEach(header => {
                        tr.append($('<td>').text(row[header] || ''));
                    });
                    tr.append($('<td>').html(`
                <button class="btn btn-primary btn-sm" onclick="showDHDetails('${row['SỐ ĐƠN HÀNG']}')">
                    <i class="fas fa-eye"></i>
                </button>
            `));
                    tbody.append(tr);
                });
                table.append(tbody);

                if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                    $(`#${tableId}`).DataTable().destroy();
                }

                $(`#${tableId}`).DataTable({
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ]
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu'));
                FuiToast.warning(`Không có dữ liệu`);
            }
        }

        function showDHDetails(soDonHang) {
            const dhDetails = sheetData.dhDetail.filter(detail => detail['SỐ ĐƠN HÀNG'] === soDonHang);
            let modalContent = `
        <div class="modal-header">
            <h5 class="modal-title">Chi tiết Đơn Hàng: ${soDonHang}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
    `;

            if (dhDetails.length > 0) {
                modalContent += '<table id="dhDetailTable" class="fui-table-ui-basic-linh table-wrap" style="width:100%"></table>';
            } else {
                modalContent += '<p>Không có chi tiết cho đơn hàng này.</p>';
            }

            modalContent += '</div>';

            $('#detailModal .modal-content').html(modalContent);

            if (dhDetails.length > 0) {
                $('#dhDetailTable').DataTable({
                    data: dhDetails,
                    columns: Object.keys(dhDetails[0]).map(key => ({ title: key, data: key })),
                    pageLength: 5,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Tất cả"]],
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ]
                });
            }

            $('#detailModal').modal('show');

            $('#detailModal').on('hidden.bs.modal', function (e) {
                if ($.fn.DataTable.isDataTable('#dhDetailTable')) {
                    $('#dhDetailTable').DataTable().destroy();
                }
            });
        }

        function displayPNKTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && Object.keys(data).length > 0) {
                const headers = [...Object.keys(data[Object.keys(data)[0]]), 'Thao tác'];
                const thead = $('<thead>').append($('<tr>').append(headers.map(header => $('<th>').text(header))));
                table.append(thead);

                const tbody = $('<tbody>');
                Object.values(data).forEach(row => {
                    const tr = $('<tr>');
                    headers.slice(0, -1).forEach(header => {
                        tr.append($('<td>').text(row[header] || ''));
                    });
                    tr.append($('<td>').html(`
                <button class="btn btn-primary btn-sm" onclick="showPNKDetails('${row['Số phiếu']}', '${row['Nghiệp vụ']}')">
                    <i class="fas fa-eye"></i>
                </button>
            `));
                    tbody.append(tr);
                });
                table.append(tbody);

                if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                    $(`#${tableId}`).DataTable().destroy();
                }

                $(`#${tableId}`).DataTable({
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ]
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu'));
                FuiToast.warning(`Không có dữ liệu`);
            }
        }

        function showPNKDetails(soPhieu, loaiphieu) {
            const pnkDetails = sheetData.pnkDetail.filter(detail => detail['Số phiếu'] === soPhieu);
            let modalContent = `
        <div class="modal-header">
            <h5 class="modal-title">Chi tiết ${loaiphieu}: ${soPhieu}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">`;

            if (pnkDetails.length > 0) {
                modalContent += '<table id="pnkDetailTable" class="fui-table-ui-basic-linh table-wrap" style="width:100%"></table>';
            } else {
                modalContent += '<p>Không có chi tiết cho phiếu này.</p>';
            }

            modalContent += '</div>';

            $('#detailModal .modal-content').html(modalContent);

            if (pnkDetails.length > 0) {
                $('#pnkDetailTable').DataTable({
                    data: pnkDetails,
                    columns: Object.keys(pnkDetails[0]).map(key => ({ title: key, data: key })),
                    pageLength: 5,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Tất cả"]],
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ]
                });
            }

            $('#detailModal').modal('show');

            $('#detailModal').on('hidden.bs.modal', function (e) {
                if ($.fn.DataTable.isDataTable('#pnkDetailTable')) {
                    $('#pnkDetailTable').DataTable().destroy();
                }
            });



        }


        // Tải dữ liệu khi trang được tạo
        $(document).ready(function () {
            fetchData();
        });
    </script>
    <!-- Modal for details -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    <div class="modal fade" id="detailModal1" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        $('#detailModal').on('show.bs.modal', function () {
            setTimeout(function () {
                var modalBody = $('#detailModal .modal-body');
                var modalDialog = $('#detailModal .modal-dialog');
                var windowHeight = $(window).height();
                var windowWidth = $(window).width();

                modalBody.css('max-height', (windowHeight * 0.8) + 'px');

                var contentWidth = modalBody.prop('scrollWidth');
                var maxWidth = windowWidth * 0.9;

                if (contentWidth > maxWidth) {
                    modalDialog.css('width', maxWidth + 'px');
                } else {
                    modalDialog.css('width', 'fit-content');
                }
            }, 150);
        });
    </script>
</body>

</html>