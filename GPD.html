<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dữ liệu từ Google Sheets</title>
    <link rel="stylesheet" href="stylegpd.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
</head>

<body>
    <div id="fui-toast"></div>
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
    </div>
    <div id="content" class="" style="display: none;">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="packing-list-tab" data-bs-toggle="tab"
                    data-bs-target="#packing-list" type="button" role="tab" aria-controls="packing-list"
                    aria-selected="true">Packing List</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dh-tab" data-bs-toggle="tab" data-bs-target="#dh" type="button" role="tab"
                    aria-controls="dh" aria-selected="false">Đơn Hàng</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bg-tab" data-bs-toggle="tab" data-bs-target="#bg" type="button" role="tab"
                    aria-controls="bg" aria-selected="false">Báo Giá</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pnk-tab" data-bs-toggle="tab" data-bs-target="#pnk" type="button"
                    role="tab" aria-controls="pnk" aria-selected="false">PNK</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory"
                    type="button" role="tab" aria-controls="inventory" aria-selected="false">Báo Cáo Tồn Kho</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">

            <div class="tab-pane fade show active" id="packing-list" role="tabpanel" aria-labelledby="packing-list-tab">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2><i class="fas fa-list"></i> packing-list</h2>
                    </div>
                    <div class="card-body"></div>
                    <table id="packing-list-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;">
                    </table>
                </div>

            </div>
            <div class="tab-pane fade" id="dh" role="tabpanel" aria-labelledby="dh-tab">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h2><i class="fas fa-file-invoice"></i> Đơn hàng</h2>
                    </div>
                    <div class="card-body"></div>
                    <table id="dh-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;"></table>
                </div>

            </div>
            <div class="tab-pane fade" id="bg" role="tabpanel" aria-labelledby="bg-tab">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h2><i class="fas fa-file-invoice"></i> Báo giá</h2>
                    </div>
                    <div class="card-body"></div>
                    <table id="bg-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;"></table>
                </div>

            </div>
            <div id="pnk" class="tab-pane fade" role="tabpanel" aria-labelledby="pnk-tab">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h2>PNK</h2>
                    </div>
                    <div class="card-body">

                        <form id="pnkForm" class="mb-4">
                            <div class="row">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="nghiepVu" class="form-label">Loại nghiệp vụ:</label>
                                        <select class="form-select" id="nghiepVu" name="nghiepVu"
                                            onchange="updateLocationFields()" required>
                                            <optgroup label="Nhập kho">
                                                <option value="Nhập Mua Hàng">Nhập mua hàng</option>
                                                <option value="Nhập Trả Hàng">Nhập trả hàng</option>
                                                <option value="Nhập Tạm">Nhập tạm</option>
                                                <option value="Nhập Chuyển Kho">Nhập chuyển kho</option>
                                            </optgroup>
                                            <optgroup label="Xuất kho">
                                                <option value="Xuất Bán">Xuất bán</option>
                                                <option value="Xuất Tạm">Xuất tạm</option>
                                                <option value="Xuất Chuyển Kho">Xuất chuyển kho</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="soPhieu" class="form-label">Số phiếu:</label>
                                        <input type="text" class="form-control" id="soPhieu" name="soPhieu" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="ngayThang" class="form-label">Ngày tháng:</label>
                                        <input type="date" class="form-control" id="ngayThang" name="ngayThang"
                                            required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="tuDau" class="form-label">Từ kho:</label>
                                        <select class="form-select" id="tuDau" name="tuDau" required>
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label for="denDau" class="form-label">Đến kho:</label>
                                        <select class="form-select" id="denDau" name="denDau" required>
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-9 mb-3">
                                        <label for="dienGiai" class="form-label">Diễn giải:</label>
                                        <input type="text" class="form-control" id="dienGiai" name="dienGiai" required>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="chungTuDiKem" class="form-label">Chứng từ đi kèm:</label>
                                    <select class="form-select" id="chungTuDiKem" name="chungTuDiKem" required></select>
                                </div>
                                <div class="col-md-3 mb-3 d-flex align-items-end">
                                    <button type="submit" id="submitPNK" class="btn btn-primary w-100">Thêm mới</button>
                                </div>
                            </div>
                        </form>

                        <h3>Packing List cho INVOICE đã chọn</h3>
                        <table id="selectedPackingListTable" class="fui-table-ui-basic-linh table-wrap"
                            style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>TỜ KHAI</th>
                                    <th>NGÀY TỜ KHAI</th>
                                    <th>ĐƠN GIÁ (USD)</th>
                                    <th>ĐƠN GIÁ (EUR)</th>
                                    <th>TỶ GIÁ</th>
                                    <th>FSC</th>
                                    <th>XUẤT XỨ</th>
                                    <th>INVOICE</th>
                                    <th>TÊN NHÀ CUNG CẤP</th>
                                    <th>SỐ CONTAINER</th>
                                    <th>TÊN GỖ</th>
                                    <th>MÃ KIỆN</th>
                                    <th>KHỐI LƯỢNG THỰC TẾ</th>
                                    <th>SỐ THANH THỰC TẾ</th>
                                    <th>CHIỀU DÀI THỰC TẾ</th>
                                    <th>CHIỀU RỘNG THỰC TẾ</th>
                                    <th>MÃ KIỆN TRÊN PL</th>
                                    <th>Trạng thái kiện</th>
                                    <th>Chọn</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <h3>Danh sách PNK</h3>
                        <button id="saveButton" class="btn btn-success mb-2">Lưu dữ liệu PNK vào
                            database</button>
                    </div>
                </div>
                <table id="pnk-table" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;"></table>
            </div>
            <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h2>Báo Cáo Tồn Kho</h2>
                    </div>
                    <div class="card-body">
                        <table id="inventoryTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>MÃ KIỆN</th>
                                    <th>TÊN GỖ</th>
                                    <th>KHỐI LƯỢNG THỰC TẾ</th>
                                    <th>SỐ THANH THỰC TẾ</th>
                                    <th>CHIỀU DÀI THỰC TẾ</th>
                                    <th>CHIỀU RỘNG THỰC TẾ</th>
                                    <th>KHO HIỆN TẠI</th>
                                    <th>TRẠNG THÁI</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyKqoJs53LTmIMhW9RXHN79hDHur95r6b7tnt4HVaCZYnch-loT6albaQNtSffjyfHY/exec';
        let sheetData = {
            packingList: [],
            bg: [],
            bgDetail: [],
            dh: [],
            dhDetail: [],
            pnk: []
        };

        // Hàm chuyển đổi định dạng ngày
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // Trả về nguyên gốc nếu không phải ngày hợp lệ
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Hàm đệ quy để xử lý tất cả các trường trong một đối tượng
        function processDateFields(obj) {
            for (let key in obj) {
                if (obj[key] && typeof obj[key] === 'object') {
                    // Nếu giá trị là một đối tượng, gọi đệ quy
                    processDateFields(obj[key]);
                } else if (typeof obj[key] === 'string') {
                    // Kiểm tra nếu trường có vẻ như là một ngày
                    const datePattern = /^\d{4}-\d{2}-\d{2}|^\d{4}\/\d{2}\/\d{2}/;
                    if (datePattern.test(obj[key])) {
                        obj[key] = formatDate(obj[key]);
                    }
                }
            }
        }

        // Áp dụng cho sheetData sau khi đã lấy dữ liệu
        function applyDateFormatting() {
            processDateFields(sheetData);
        }

        async function fetchData() {
            try {
                document.getElementById('loading-overlay').style.display = 'block';
                document.getElementById('content').style.display = 'none';

                const response = await fetch(API_URL);
                const data = await response.json();

                // Chuyển đổi dữ liệu nếu cần
                sheetData = {
                    packingList: Object.values(data.packingList || {}),
                    bg: Object.values(data.bg || {}),
                    bgDetail: data.bgDetail || [],
                    dh: Object.values(data.dh || {}),
                    dhDetail: data.dhDetail || [],
                    pnkData: Object.values(data.pnk || {})

                };

                // Kiểm tra và đảm bảo rằng mỗi thuộc tính là một mảng
                for (let key in sheetData) {
                    if (!Array.isArray(sheetData[key])) {
                        console.warn(`sheetData.${key} is not an array, setting to empty array`);
                        sheetData[key] = [];
                    }
                }

                // Áp dụng định dạng ngày

                applyDateFormatting();
                displayData();
                updateInventoryReport();

                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                FuiToast.success(`Tải dữ liệu thành công`);
            } catch (error) {
                console.error('Error fetching data:', error);
                FuiToast.error(`Lỗi tìm nạp dữ liệu`);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function displayData() {
            displayPackingListTable('packing-list-table', sheetData.packingList);
            displayDHTable('dh-table', sheetData.dh);
            displayBGTable('bg-table', sheetData.bg);
            displayPNKTable('pnk-table', sheetData.pnkData)
        }

        function displayPackingListTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && data.length > 0) {
                const headers = ['TỜ KHAI', 'INVOICE', 'TÊN NHÀ CUNG CẤP', 'SỐ CONTAINER', 'TÊN GỖ', 'MÃ KIỆN', 'KHỐI LƯỢNG THỰC TẾ', 'SỐ THANH THỰC TẾ', 'CHIỀU DÀI THỰC TẾ', 'CHIỀU RỘNG THỰC TẾ', 'MÃ KIỆN TRÊN PL', 'Chi tiết'];
                const tableData = data.map(row => {
                    const rowData = headers.slice(0, -1).map(header => row[header] || '');
                    rowData.push('<button class="btn btn-primary btn-sm detail-btn"><i class="fas fa-eye"></i></button>');
                    return rowData;
                });

                if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                    $(`#${tableId}`).DataTable().destroy();
                }

                $(`#${tableId}`).DataTable({
                    data: tableData,
                    columns: headers.map(header => ({ title: header })),
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                });

                $(`#${tableId} tbody`).on('click', '.detail-btn', function () {
                    const rowData = $(`#${tableId}`).DataTable().row($(this).closest('tr')).data();
                    showPackingListDetails(data.find(row => row['MÃ KIỆN'] === rowData[5]));
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu'));
                FuiToast.warning(`Không có dữ liệu`);
            }
        }

        function displayPNKTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && data.length > 0) {
                const headers = Object.keys(data[0]);
                const thead = $('<thead>').append($('<tr>').append(headers.map(header => $('<th>').text(header))));
                table.append(thead);

                const tbody = $('<tbody>');
                data.forEach(row => {
                    const tr = $('<tr>');
                    headers.forEach(header => {
                        tr.append($('<td>').text(row[header] || ''));
                    });
                    tbody.append(tr);
                });
                table.append(tbody);

                if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                    $(`#${tableId}`).DataTable().destroy();
                }

                $(`#${tableId}`).DataTable({
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu PNK'));
                FuiToast.warning(`Không có dữ liệu PNK`);
            }
        }

        function showPackingListDetails(row) {
            let modalContent = '<div class="modal-header"><h5 class="modal-title">Chi tiết Packing List</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>';
            modalContent += '<div class="modal-body">';
            for (let key in row) {
                modalContent += `<p><strong>${key}:</strong> ${row[key]}</p>`;
            }
            modalContent += '</div>';

            $('#detailModal1 .modal-content').html(modalContent);
            $('#detailModal1').modal('show');
        }

        function displayBGTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && data.length > 0) {
                const headers = [...Object.keys(data[0]), 'Chi tiết'];
                const tableData = data.map(row => {
                    const rowData = headers.slice(0, -1).map(header => row[header] || '');
                    rowData.push(`<button class="btn btn-primary btn-sm" onclick="showBGDetails('${row['SỐ BÁO GIÁ']}')"><i class="fas fa-eye"></i></button>`);
                    return rowData;
                });

                if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                    $(`#${tableId}`).DataTable().destroy();
                }

                $(`#${tableId}`).DataTable({
                    data: tableData,
                    columns: headers.map(header => ({ title: header })),
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu'));
                FuiToast.warning(`Không có dữ liệu`);
            }
        }

        function showBGDetails(soBaoGia) {
            const bgDetails = sheetData.bgDetail.filter(detail => detail['SỐ BÁO GIÁ'] === soBaoGia);
            let modalContent = `
        <div class="modal-header">
            <h5 class="modal-title">Chi tiết Báo Giá: ${soBaoGia}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
    `;

            if (bgDetails.length > 0) {
                modalContent += '<table id="bgDetailTable" class="fui-table-ui-basic-linh table-wrap" style="width:100%"></table>';
            } else {
                modalContent += '<p>Không có chi tiết cho báo giá này.</p>';
            }

            modalContent += '</div>';

            $('#detailModal .modal-content').html(modalContent);

            if (bgDetails.length > 0) {
                $('#bgDetailTable').DataTable({
                    data: bgDetails,
                    columns: Object.keys(bgDetails[0]).map(key => ({ title: key, data: key })),
                    pageLength: 5,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Tất cả"]],
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                });
            }

            $('#detailModal').modal('show');

            $('#detailModal').on('hidden.bs.modal', function (e) {
                if ($.fn.DataTable.isDataTable('#bgDetailTable')) {
                    $('#bgDetailTable').DataTable().destroy();
                }
            });
        }

        function displayDHTable(tableId, data) {
            const table = $(`#${tableId}`);
            table.empty();

            if (data && data.length > 0) {
                const headers = [...Object.keys(data[0]), 'Chi tiết'];
                const tableData = data.map(row => {
                    const rowData = headers.slice(0, -1).map(header => row[header] || '');
                    rowData.push(`<button class="btn btn-primary btn-sm" onclick="showDHDetails('${row['SỐ ĐƠN HÀNG']}')"><i class="fas fa-eye"></i></button>`);
                    return rowData;
                });

                if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                    $(`#${tableId}`).DataTable().destroy();
                }

                $(`#${tableId}`).DataTable({
                    data: tableData,
                    columns: headers.map(header => ({ title: header })),
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                });
            } else {
                table.append($('<p>').text('Không có dữ liệu'));
                FuiToast.warning(`Không có dữ liệu`);
            }
        }

        function showDHDetails(soDonHang) {
            const dhDetails = sheetData.dhDetail.filter(detail => detail['SỐ ĐƠN HÀNG'] === soDonHang);
            let modalContent = `
        <div class="modal-header">
            <h5 class="modal-title">Chi tiết Đơn Hàng: ${soDonHang}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
    `;

            if (dhDetails.length > 0) {
                modalContent += '<table id="dhDetailTable" class="fui-table-ui-basic-linh table-wrap" style="width:100%"></table>';
            } else {
                modalContent += '<p>Không có chi tiết cho đơn hàng này.</p>';
            }

            modalContent += '</div>';

            $('#detailModal .modal-content').html(modalContent);

            if (dhDetails.length > 0) {
                $('#dhDetailTable').DataTable({
                    data: dhDetails,
                    columns: Object.keys(dhDetails[0]).map(key => ({ title: key, data: key })),
                    pageLength: 5,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Tất cả"]],
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                    },
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                });
            }

            $('#detailModal').modal('show');

            $('#detailModal').on('hidden.bs.modal', function (e) {
                if ($.fn.DataTable.isDataTable('#dhDetailTable')) {
                    $('#dhDetailTable').DataTable().destroy();
                }
            });
        }


        document.addEventListener('DOMContentLoaded', function () {
            fetchData();
        });

        // Giả sử sheetData đã được định nghĩa ở đâu đó trong code của bạn
        function createInventoryReport(sheetData) {
            const { packingList, pnkData } = sheetData;
            const inventoryReport = [];

            for (const item of packingList) {
                const inventoryItem = {
                    MÃ_KIỆN: item['MÃ KIỆN'] || '',
                    TÊN_GỖ: item['TÊN GỖ'] || '',
                    KHỐI_LƯỢNG_THỰC_TẾ: item['KHỐI LƯỢNG THỰC TẾ'] || '',
                    SỐ_THANH_THỰC_TẾ: item['SỐ THANH THỰC TẾ'] || '',
                    CHIỀU_DÀI_THỰC_TẾ: item['CHIỀU DÀI THỰC TẾ'] || '',
                    CHIỀU_RỘNG_THỰC_TẾ: item['CHIỀU RỘNG THỰC TẾ'] || '',
                    KHO_HIỆN_TẠI: "",
                    TRẠNG_THÁI: "Đang về"
                };

                if (pnkData && pnkData.length > 0) {
                    const relatedPnk = pnkData.filter(p => p.danhSáchKiện && p.danhSáchKiện.includes(item['MÃ KIỆN']));
                    if (relatedPnk.length > 0) {
                        const latestPnk = relatedPnk.reduce((a, b) => new Date(a.ngàyTháng) > new Date(b.ngàyTháng) ? a : b);
                        if (latestPnk.loạiNghiệpVụ && latestPnk.loạiNghiệpVụ.startsWith("Nhập")) {
                            inventoryItem.TRẠNG_THÁI = "Tồn kho";
                            inventoryItem.KHO_HIỆN_TẠI = latestPnk.đếnKho || "";
                        } else {
                            inventoryItem.TRẠNG_THÁI = "Hết hàng";
                        }
                    }
                }

                inventoryReport.push(inventoryItem);
            }

            return inventoryReport;
        }
        function displayInventoryReport(inventoryReport) {
            const table = $('#inventoryTable');
            if ($.fn.DataTable.isDataTable(table)) {
                table.DataTable().destroy();
            }

            table.DataTable({
                data: inventoryReport,
                columns: [
                    { data: 'MÃ_KIỆN', title: 'MÃ KIỆN' },
                    { data: 'TÊN_GỖ', title: 'TÊN GỖ' },
                    { data: 'KHỐI_LƯỢNG_THỰC_TẾ', title: 'KHỐI LƯỢNG THỰC TẾ' },
                    { data: 'SỐ_THANH_THỰC_TẾ', title: 'SỐ THANH THỰC TẾ' },
                    { data: 'CHIỀU_DÀI_THỰC_TẾ', title: 'CHIỀU DÀI THỰC TẾ' },
                    { data: 'CHIỀU_RỘNG_THỰC_TẾ', title: 'CHIỀU RỘNG THỰC TẾ' },
                    { data: 'KHO_HIỆN_TẠI', title: 'KHO HIỆN TẠI' },
                    { data: 'TRẠNG_THÁI', title: 'TRẠNG THÁI' }
                ],
                responsive: true,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json'
                },
                dom: '<"top"Bfl>rt<"bottom"ip><"clear">',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Tất cả"]],
                pageLength: 10,
                order: [[0, 'asc']], // Sắp xếp theo cột đầu tiên (MÃ KIỆN) tăng dần
                searching: true,
                info: true,
                paging: true
            });
        }
        function updateInventoryReport() {
            const inventoryReport = createInventoryReport(sheetData);
            displayInventoryReport(inventoryReport);
        }
        // Khi tab Báo Cáo Tồn Kho được chọn
        document.getElementById('inventory-tab').addEventListener('shown.bs.tab', function (e) {
            updateInventoryReport();
        });

    </script>
    <!-- Modal for details -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    <div class="modal fade" id="detailModal1" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        $('#detailModal').on('show.bs.modal', function () {
            setTimeout(function () {
                var modalBody = $('#detailModal .modal-body');
                var modalDialog = $('#detailModal .modal-dialog');
                var windowHeight = $(window).height();
                var windowWidth = $(window).width();

                modalBody.css('max-height', (windowHeight * 0.8) + 'px');

                var contentWidth = modalBody.prop('scrollWidth');
                var maxWidth = windowWidth * 0.9;

                if (contentWidth > maxWidth) {
                    modalDialog.css('width', maxWidth + 'px');
                } else {
                    modalDialog.css('width', 'fit-content');
                }
            }, 150);
        });
    </script>
</body>

</html>