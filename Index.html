<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing List and PNK Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.5.1.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"
        defer></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .container {
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 8px 8px 0 0;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #3498db;
            color: white;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #loadingOverlay>div {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .select2-container {
            width: 100% !important;
        }

        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .btn-icon {
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px;
        }

        .btn-icon .fas {
            font-size: 18px;
            color: #3498db;
        }

        .btn-icon.edit-btn:hover .fas {
            color: #2980b9;
        }

        .btn-icon.delete-btn:hover .fas {
            color: #e74c3c;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group input,
        .input-group select {
            flex: 1;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .actions button {
            width: 30%;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="loadingOverlay">
            <div>Hệ thống đang tải dữ liệu...</div>
        </div>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'PackingList')">Packing List</button>
            <button class="tablinks" onclick="openTab(event, 'PNK')">PNK</button>
        </div>

        <div id="PackingList" class="tabcontent">
            <h2>Packing List</h2>
            <table id="packingListTable" class="display" style="width:100%">
                <thead>
                    <tr id="packingListHeader"></tr>
                </thead>
                <tbody id="packingListBody"></tbody>
            </table>
        </div>

        <div id="PNK" class="tabcontent">
            <h2>PNK</h2>
            <form id="pnkForm">
                <div id="pnkCommonInputs" class="input-group">
                    <!-- Các input chung sẽ được thêm vào đây bằng JavaScript -->
                </div>
                <div id="pnkInputs" class="input-group">
                    <select name="Chứng từ đi kèm" id="chungTuSelect"></select>
                </div>
                <div id="filteredPackingListContainer">
                    <table id="filteredPackingListTable">
                        <thead>
                            <tr>
                                <!-- Headers sẽ được thêm vào đây bằng JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="filteredPackingListBody"></tbody>
                    </table>
                </div>
                <div class="actions">
                    <button type="button" id="addPNKButton">Thêm PNK</button>
                    <button type="button" id="updatePNKButton">Cập nhật PNK</button>
                    <button type="button" onclick="clearPNKForm()">Xóa Form</button>
                </div>
            </form>
            <table id="pnkTable" class="display" style="width:100%">
                <thead>
                    <tr id="pnkHeader"></tr>
                </thead>
                <tbody id="pnkBody"></tbody>
            </table>
        </div>
    </div>



    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec';
        let packingListData = null;
        let pnkData = null;
        let packingListTable = null;
        let pnkTable = null;

        async function initializeData() {
            showLoading(true);
            try {
                const packingListResponse = await fetch(`${API_URL}?action=getPackingList`);
                if (!packingListResponse.ok) {
                    throw new Error('Failed to fetch Packing List data');
                }
                const packingListText = await packingListResponse.text();
                packingListData = JSON.parse(packingListText);
                console.log("Packing List data loaded");

                const pnkResponse = await fetch(`${API_URL}?action=getPNK`);
                if (!pnkResponse.ok) {
                    throw new Error('Failed to fetch PNK data');
                }
                const pnkText = await pnkResponse.text();
                pnkData = JSON.parse(pnkText);
                console.log("PNK data loaded");
                setupPNKForm();

                // Mở tab Packing List mặc định sau khi dữ liệu đã được tải
                document.getElementsByClassName('tablinks')[0].click();

            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Đảm bảo jQuery đã sẵn sàng
            if (typeof jQuery !== 'undefined') {
                // Khởi tạo Select2
                $(document).ready(function () {
                    $('#chungTuSelect').select2({
                        placeholder: "Chọn Chứng từ đi kèm",
                        allowClear: true,
                        width: 'resolve'
                    });
                });
            } else {
                console.error('jQuery is not loaded');
            }

            // Gọi hàm khởi tạo dữ liệu của bạn
            initializeData();
        });

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        function openTab(evt, tabName) {
            if (packingListData && pnkData) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                const tabElement = document.getElementById(tabName);
                if (tabElement) {
                    tabElement.style.display = "block";
                    evt.currentTarget.className += " active";

                    if (tabName === 'PackingList') {
                        displayPackingList();
                    } else if (tabName === 'PNK') {
                        displayPNK();
                    }
                } else {
                    console.error(`Tab element with id '${tabName}' not found`);
                }
            } else {
                console.log("Data not loaded yet");
            }
        }

        function displayPackingList() {
            if (packingListData) {
                renderPackingListTable();
            } else {
                document.getElementById('packingListBody').innerHTML = '<tr><td>No data available</td></tr>';
            }
        }

        function renderPackingListTable() {
            const headers = packingListData[0];
            const headerRow = document.getElementById('packingListHeader');
            headerRow.innerHTML = headers.map(header => `<th>${header}</th>`).join('');

            if (packingListTable) {
                packingListTable.destroy();
            }

            packingListTable = $('#packingListTable').DataTable({
                data: packingListData.slice(1),
                columns: headers.map(header => ({ title: header })),
                pageLength: 100,
                scrollY: '60vh',
                scrollCollapse: true,
                language: {
                    "decimal": "",
                    "emptyTable": "Không có dữ liệu trong bảng",
                    "info": "Hiển thị từ _START_ đến _END_ của _TOTAL_ mục",
                    "infoEmpty": "Hiển thị từ 0 đến 0 của 0 mục",
                    "infoFiltered": "(lọc từ _MAX_ mục)",
                    "infoPostFix": "",
                    "thousands": ",",
                    "lengthMenu": "Hiển thị _MENU_ mục",
                    "loadingRecords": "Đang tải...",
                    "processing": "Đang xử lý...",
                    "search": "Tìm kiếm:",
                    "zeroRecords": "Không tìm thấy kết quả",
                    "paginate": {
                        "first": "Đầu tiên",
                        "last": "Cuối cùng",
                        "next": "Tiếp",
                        "previous": "Trước"
                    },
                    "aria": {
                        "sortAscending": ": sắp xếp tăng dần",
                        "sortDescending": ": sắp xếp giảm dần"
                    }
                }
            });
        }
        function displayPNK() {
            if (pnkData) {
                renderPNKTable();
                // setupPNKForm(); // Đã được gọi trong initializeData, không cần gọi lại ở đây
            } else {
                const pnkBody = document.getElementById('pnkBody');
                if (pnkBody) {
                    pnkBody.innerHTML = '<tr><td>No data available in table</td></tr>';
                } else {
                    console.error("Element with id 'pnkBody' not found");
                }
            }
        }

        function renderPNKTable() {
            const headers = pnkData[0];
            const headerRow = document.getElementById('pnkHeader');
            headerRow.innerHTML = headers.map(header => `<th>${header}</th>`).join('') + '<th>Actions</th>';

            if (pnkTable) {
                pnkTable.destroy();
            }

            pnkTable = $('#pnkTable').DataTable({
                data: pnkData.slice(1),
                columns: [
                    ...headers.map((header, index) => ({
                        title: header,
                        render: function (data, type, row) {
                            // Kiểm tra nếu đây là cột ngày tháng (giả sử là cột thứ 3, index 2)
                            if (index === 2) {
                                return formatDate(data);
                            }
                            return data;
                        }
                    })),
                    {
                        title: 'Thao tác',
                        render: function (data, type, row, meta) {
                            return `
                        <button onclick="editPNK(${meta.row + 2})" class="btn-icon edit-btn" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePNK(${meta.row + 2})" class="btn-icon delete-btn" title="Xóa">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                        }
                    }
                ],
                pageLength: 50,
                scrollY: '50vh',
                scrollCollapse: true,
                language: {
                    "decimal": "",
                    "emptyTable": "Không có dữ liệu trong bảng",
                    "info": "Hiển thị từ _START_ đến _END_ của _TOTAL_ mục",
                    "infoEmpty": "Hiển thị từ 0 đến 0 của 0 mục",
                    "infoFiltered": "(lọc từ _MAX_ mục)",
                    "infoPostFix": "",
                    "thousands": ",",
                    "lengthMenu": "Hiển thị _MENU_ mục",
                    "loadingRecords": "Đang tải...",
                    "processing": "Đang xử lý...",
                    "search": "Tìm kiếm:",
                    "zeroRecords": "Không tìm thấy kết quả",
                    "paginate": {
                        "first": "Đầu tiên",
                        "last": "Cuối cùng",
                        "next": "Tiếp",
                        "previous": "Trước"
                    },
                    "aria": {
                        "sortAscending": ": sắp xếp tăng dần",
                        "sortDescending": ": sắp xếp giảm dần"
                    }
                }
            });
        }
        let selectedPackingList = [];

        function setupPNKForm() {
            console.log("Setting up PNK Form");

            const commonForm = document.getElementById('pnkCommonInputs');
            if (commonForm) {
                commonForm.innerHTML = `
            <input type="hidden" id="editingRowId" name="editingRowId">
            <select id="nghiepVu" name="Nghiệp vụ">
                <option value="">Chọn nghiệp vụ</option>
                <option value="Nhập kho">Nhập kho</option>
                <option value="Xuất kho">Xuất kho</option>
                <option value="Chuyển kho">Chuyển kho</option>
                <option value="Trả hàng">Trả hàng</option>
            </select>
            <input type="text" id="soPhieu" name="Số phiếu" readonly>
            <input type="date" id="ngayThang" name="Ngày tháng">
            <input type="text" id="tuDau" name="Từ đâu">
            <input type="text" id="denDau" name="Đến">
            <input type="text" id="dienGiai" name="Diễn giải">
        `;
                const nghiepVuSelect = document.getElementById('nghiepVu');
                const soPhieuInput = document.getElementById('soPhieu');
                const ngayThangInput = document.getElementById('ngayThang');
                const tuDauInput = document.getElementById('tuDau');
                const denDauInput = document.getElementById('denDau');

                nghiepVuSelect.addEventListener('change', updateFields);
                ngayThangInput.addEventListener('change', updateSoPhieu);

                function updateFields() {
                    const nghiepVu = nghiepVuSelect.value;
                    if (nghiepVu === 'Nhập kho') {
                        tuDauInput.value = 'Kho NCC';
                        denDauInput.value = 'Kho An Phú';
                    } else if (nghiepVu === 'Xuất kho') {
                        tuDauInput.value = 'Kho An Phú';
                        denDauInput.value = 'Kho Khách Hàng';
                    } else if (nghiepVu === 'Chuyển kho') {
                        tuDauInput.value = '';
                        denDauInput.value = '';
                    } else if (nghiepVu === 'Trả hàng') {
                        tuDauInput.value = 'Kho Khách Hàng';
                        denDauInput.value = 'Kho An Phú';
                    } else {
                        tuDauInput.value = '';
                        denDauInput.value = '';
                    }
                    updateSoPhieu();
                }

                function updateSoPhieu() {
                    const nghiepVu = nghiepVuSelect.value;
                    const ngayThang = ngayThangInput.value.replace(/-/g, '');
                    const tuDau = tuDauInput.value;
                    const denDau = denDauInput.value;

                    if (nghiepVu === 'Nhập kho') {
                        soPhieuInput.value = `PNK-${tuDau}-${denDau}-${ngayThang}`;
                    } else if (nghiepVu === 'Xuất kho') {
                        soPhieuInput.value = `PXK-${tuDau}-${denDau}-${ngayThang}`;
                    } else if (nghiepVu === 'Chuyển kho') {
                        soPhieuInput.value = `PCK-${tuDau}-${denDau}-${ngayThang}`;
                    } else if (nghiepVu === 'Trả hàng') {
                        soPhieuInput.value = `PTH-${tuDau}-${denDau}-${ngayThang}`;
                    } else {
                        soPhieuInput.value = '';
                    }
                }

                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                ngayThangInput.value = today;
            } else {
                console.error("Common form element not found");
            }

            const chungTuSelect = document.getElementById('chungTuSelect');
            if (chungTuSelect) {
                // Populate options
                const uniqueChungTu = [...new Set(packingListData.slice(1).map(item => item[7]))];
                chungTuSelect.innerHTML = '<option value="">Select Chứng từ</option>' +
                    uniqueChungTu.map(item => `<option value="${item}">${item}</option>`).join('');

                // Initialize Select2
                if ($.fn.select2) {
                    $(chungTuSelect).select2({
                        placeholder: "Chọn Chứng từ đi kèm",
                        allowClear: true,
                        width: 'resolve'
                    });
                } else {
                    console.error('Select2 is not loaded');
                }

                // Set up change event
                chungTuSelect.addEventListener('change', function () {
                    console.log("chungTuSelect changed to:", this.value);
                    updateFilteredPackingListTable(this.value);
                });
                // Nếu bạn đang sử dụng Select2, hãy thêm đoạn này
                $(chungTuSelect).on('select2:select', function (e) {
                    console.log("Select2 selection changed to:", e.params.data.id);
                    updateFilteredPackingListTable(e.params.data.id);
                });
            } else {
                console.error("Chung tu select element not found");
            }

            // Set up the filtered packing list table
            const filteredPackingListTable = document.getElementById('filteredPackingListTable');
            if (filteredPackingListTable) {
                const headerRow = filteredPackingListTable.querySelector('thead tr');
                if (headerRow) {
                    headerRow.innerHTML = packingListData[0].map(header => `<th>${header}</th>`).join('') + '<th>Action</th>';
                } else {
                    console.error("Header row not found in filtered packing list table");
                }
            } else {
                console.error("Filtered packing list table not found");
            }

            const addPNKButton = document.getElementById('addPNKButton');
            const updatePNKButton = document.getElementById('updatePNKButton');

            if (addPNKButton) {
                addPNKButton.onclick = addPNK;
            } else {
                console.error("Add PNK button not found");
            }

            if (updatePNKButton) {
                updatePNKButton.onclick = updatePNK;
                updatePNKButton.style.display = 'none'; // Hide update button initially
            } else {
                console.error("Update PNK button not found");
            }

            const pnkForm = document.getElementById('pnkForm');
            if (pnkForm) {
                pnkForm.onsubmit = (e) => {
                    e.preventDefault();
                };
            } else {
                console.error("PNK form not found");
            }

            console.log("PNK Form setup completed");
        }

        async function addPNK() {
            const pnkData = getPNKFormData();
            // Thực hiện logic thêm mới PNK
            await sendPNKData('add', pnkData);
        }
        async function updatePNK() {
            const editingRowId = document.getElementById('editingRowId').value;
            if (!editingRowId) {
                alert('Không có dòng nào đang được chỉnh sửa.');
                return;
            }

            const pnkData = getPNKFormData();
            pnkData.rowId = editingRowId;

            // Thực hiện logic cập nhật PNK
            await sendPNKData('update', pnkData);
        }
        function getPNKFormData() {
            const formData = {};

            // Get common input values
            const commonInputs = document.querySelectorAll('#pnkCommonInputs input');
            commonInputs.forEach(input => {
                formData[input.name] = input.value;
            });

            // Get selected Chứng từ đi kèm
            const chungTuSelect = document.getElementById('chungTuSelect');
            if (chungTuSelect) {
                formData['Chứng từ đi kèm'] = chungTuSelect.value;
            }

            // Get filtered packing list data
            const filteredPackingListRows = document.querySelectorAll('#filteredPackingListBody tr');
            const packingListData = Array.from(filteredPackingListRows).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    'Mã kiện (NB)': cells[11].textContent, // Assuming Mã kiện (NB) is in the 12th column
                    // Add other relevant data from the row
                };
            });

            formData['PackingListData'] = packingListData;

            console.log("Form data collected:", formData);
            return formData;
        }
        async function sendPNKData(action, data) {
            showLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: action === 'add' ? 'addPNK' : 'updatePNK',
                        data: data
                    })
                });
                const result = await response.text();
                console.log(`${action.charAt(0).toUpperCase() + action.slice(1)} result:`, result);

                await refreshPNKData();
                renderPNKTable();
                clearPNKForm();
            } catch (error) {
                console.error(`Error ${action}ing PNK:`, error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        function updateChungTuOptions() {
            const chungTuSelect = document.getElementById('chungTuSelect');
            if (chungTuSelect) {
                // Update options
                chungTuSelect.innerHTML = '<option value="">Select Chứng từ</option>' +
                    [...new Set(packingListData.slice(1).map(item => item[7]))]
                        .map(item => `<option value="${item}">${item}</option>`)
                        .join('');

                // Reinitialize Select2
                $(chungTuSelect).select2('destroy').select2({
                    placeholder: "Chọn Chứng từ đi kèm",
                    allowClear: true,
                    width: 'resolve'
                });
            }
        }

        function updateFilteredPackingListTable(selectedChungTu) {
            console.log("Updating filtered packing list table for:", selectedChungTu);

            const filteredPackingListBody = document.getElementById('filteredPackingListBody');
            const tableHeader = document.querySelector('#filteredPackingListTable thead tr');

            if (!filteredPackingListBody || !tableHeader) {
                console.error("Required elements not found");
                return;
            }

            // Cập nhật headers
            const headers = packingListData[0];
            tableHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join('') + '<th>Action</th>';

            // Xóa các hàng cũ
            filteredPackingListBody.innerHTML = '';

            if (!selectedChungTu) {
                console.log("No Chứng từ selected, table cleared");
                return;
            }

            // Lọc dữ liệu Packing List dựa trên Chứng từ đi kèm được chọn
            const filteredData = packingListData.slice(1).filter(item => item[7] === selectedChungTu);
            console.log("Filtered data:", filteredData);

            // Thêm các hàng mới
            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = item.map((cell, cellIndex) => {
                    // Kiểm tra nếu đây là cột ngày tháng (giả sử là cột thứ 3, index 2)
                    if (cellIndex === 2) {
                        return `<td>${formatDate(cell)}</td>`;
                    }
                    return `<td>${cell}</td>`;
                }).join('') +
                    `<td><button type="button" onclick="removeFilteredPackingListRow(${index})">Xóa</button></td>`;
                filteredPackingListBody.appendChild(row);
            });

            console.log("Rows added:", filteredPackingListBody.children.length);
        }

        function removeFilteredPackingListRow(index) {
            const filteredPackingListBody = document.getElementById('filteredPackingListBody');
            if (filteredPackingListBody && filteredPackingListBody.children[index]) {
                filteredPackingListBody.children[index].remove();
            }
        }
        function addPackingListRow() {
            const chungTu = document.getElementById('chungTuSelect').value;
            if (!chungTu) {
                alert('Vui lòng chọn Chứng từ đi kèm');
                return;
            }

            const maKienOptions = packingListData
                .filter(item => item[7] === chungTu)
                .map(item => item[11]);

            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${chungTu}</td>
        <td>
            <select name="Mã kiện (NB)">
                <option value="">Select Mã kiện</option>
                ${maKienOptions.map(item => `<option value="${item}">${item}</option>`).join('')}
            </select>
        </td>
        <td><button type="button" onclick="removePackingListRow(this)">Xóa</button></td>
    `;

            document.getElementById('packingListBody').appendChild(row);
            selectedPackingList.push({ chungTu, maKien: '' });

            row.querySelector('select').addEventListener('change', function () {
                const index = Array.from(this.closest('tbody').children).indexOf(this.closest('tr'));
                selectedPackingList[index].maKien = this.value;
            });
        }
        function updatePackingListTable(selectedChungTu) {
            const packingListBody = document.getElementById('packingListBody');
            if (!packingListBody) {
                console.error("Element with id 'packingListBody' not found");
                return;
            }

            // Lọc dữ liệu Packing List dựa trên Chứng từ đi kèm được chọn
            const filteredData = packingListData.filter(item => item[7] === selectedChungTu);

            // Xóa các hàng cũ
            packingListBody.innerHTML = '';

            // Thêm các hàng mới
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${item[7]}</td>
            <td>${item[11]}</td>
            <td><button type="button" onclick="removePackingListRow(this)">Xóa</button></td>
        `;
                packingListBody.appendChild(row);
            });

            // Cập nhật selectedPackingList
            selectedPackingList = filteredData.map(item => ({
                chungTu: item[7],
                maKien: item[11]
            }));
        }
        function removePackingListRow(button) {
            const row = button.closest('tr');
            const index = Array.from(row.parentNode.children).indexOf(row);
            selectedPackingList.splice(index, 1);
            row.remove();
        }

        function addPNKRow() {
            const rowsContainer = document.getElementById('pnkRowsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'pnkRow';

            const table = document.createElement('table');
            const tr = document.createElement('tr');

            const td1 = document.createElement('td');
            const chungTuSelect = document.createElement('select');
            chungTuSelect.name = 'Chứng từ đi kèm';
            chungTuSelect.innerHTML = '<option value="">Select Chứng từ</option>' +
                [...new Set(packingListData.slice(1).map(item => item[7]))]
                    .map(item => `<option value="${item}">${item}</option>`)
                    .join('');
            td1.appendChild(chungTuSelect);

            const td2 = document.createElement('td');
            const maKienSelect = document.createElement('select');
            maKienSelect.name = 'Mã kiện (NB)';
            maKienSelect.innerHTML = '<option value="">Select Mã kiện</option>';
            td2.appendChild(maKienSelect);

            tr.appendChild(td1);
            tr.appendChild(td2);
            table.appendChild(tr);
            newRow.appendChild(table);

            rowsContainer.appendChild(newRow);

            setupRowListeners(newRow);
        }
        function setupRowListeners(row) {
            const chungTuSelect = row.querySelector('select[name="Chứng từ đi kèm"]');
            const maKienSelect = row.querySelector('select[name="Mã kiện (NB)"]');

            chungTuSelect.addEventListener('change', updateMaKienOptions);
            maKienSelect.addEventListener('change', function () {
                console.log("Mã kiện changed:", this.value);
            });

            chungTuSelect.addEventListener('focusout', logSelectValues);
            maKienSelect.addEventListener('focusout', logSelectValues);
        }

        function logSelectValues() {
            const row = this.closest('.pnkRow');
            const chungTuValue = row.querySelector('select[name="Chứng từ đi kèm"]').value;
            const maKienValue = row.querySelector('select[name="Mã kiện (NB)"]').value;
            console.log("Current values - Chứng từ:", chungTuValue, "Mã kiện:", maKienValue);
        }
        function updateMaKienOptions(e) {
            const selectedChungTu = e.target.value;
            const pnkRow = e.target.closest('.pnkRow');
            const maKienNBSelect = pnkRow.querySelector('select[name="Mã kiện (NB)"]');

            if (maKienNBSelect) {
                const correspondingMaKiens = packingListData
                    .filter(item => item[7] === selectedChungTu)
                    .map(item => item[11]);

                maKienNBSelect.innerHTML = '<option value="">Select Mã kiện</option>' +
                    correspondingMaKiens.map(item => `<option value="${item}">${item}</option>`).join('');

                // Không trigger change event tự động
                console.log("Mã kiện options updated for:", selectedChungTu);
            }
        }

        let pnkRows = [];

        async function addOrUpdatePNK() {
            const commonInputs = document.querySelectorAll('#pnkCommonInputs input');
            const commonData = {};
            commonInputs.forEach(input => {
                commonData[input.name] = input.value;
            });

            const chungTuSelect = document.getElementById('chungTuSelect');
            const selectedChungTu = chungTuSelect ? chungTuSelect.value : '';
            commonData['Chứng từ đi kèm'] = selectedChungTu;

            const filteredPackingListRows = document.querySelectorAll('#filteredPackingListBody tr');
            const pnkRows = Array.from(filteredPackingListRows).map(row => {
                const rowData = { ...commonData };
                const maKienNB = row.querySelector('td:nth-child(12)').textContent;
                rowData['Mã kiện (NB)'] = maKienNB;
                return rowData;
            });

            console.log("All data to be sent:", pnkRows);

            showLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',

                    body: JSON.stringify({
                        action: 'addPNK',
                        data: pnkRows
                    })
                });
                const result = await response.text();
                console.log("Add/Update result:", result);

                if (result.includes("rows added successfully")) {
                    for (let rowData of pnkRows) {
                        const newRowData = Object.values(rowData);
                        pnkTable.row.add(newRowData).draw(false);
                    }
                }

                await refreshPNKData();
                renderPNKTable();
                clearPNKForm();
            } catch (error) {
                console.error("Error adding/updating PNK:", error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function refreshPNKData() {
            const pnkResponse = await fetch(`${API_URL}?action=getPNK`);
            const pnkText = await pnkResponse.text();
            pnkData = JSON.parse(pnkText);
        }
        function clearPNKForm() {
            const commonInputs = document.querySelectorAll('#pnkCommonInputs input, #pnkCommonInputs select');
            commonInputs.forEach(input => {
                if (input.type !== 'hidden') {
                    input.value = '';
                }
            });

            document.getElementById('editingRowId').value = '';

            const chungTuSelect = document.getElementById('chungTuSelect');
            if (chungTuSelect) {
                chungTuSelect.value = '';
                $(chungTuSelect).trigger('change'); // Nếu bạn đang sử dụng Select2
            }

            const filteredPackingListBody = document.getElementById('filteredPackingListBody');
            if (filteredPackingListBody) {
                filteredPackingListBody.innerHTML = '';
            }

            document.getElementById('addPNKButton').style.display = 'inline-block';
            document.getElementById('updatePNKButton').style.display = 'none';
        }
        function logFormData() {
            const form = document.getElementById('pnkForm');
            const formData = new FormData(form);
            console.log("Form data before submission:");
            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }
        }


        function editPNK(rowIndex) {
            const rowData = pnkTable.row(rowIndex - 2).data();
            const form = document.getElementById('pnkForm');
            const inputs = form.querySelectorAll('input, select');

            // Xóa tất cả các hàng hiện có trong bảng filteredPackingList
            const filteredPackingListBody = document.getElementById('filteredPackingListBody');
            filteredPackingListBody.innerHTML = '';

            // Điền thông tin vào form
            inputs.forEach((input, index) => {
                if (input.type !== 'submit' && input.type !== 'button') {
                    if (input.name === 'Ngày tháng') {
                        // Kiểm tra xem giá trị có phải là chuỗi và có đúng định dạng không
                        if (typeof rowData[index] === 'string' && rowData[index].includes('/')) {
                            try {
                                const [day, month, year] = rowData[index].split('/');
                                input.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            } catch (error) {
                                console.error('Error parsing date:', error);
                                input.value = ''; // Nếu có lỗi, để trống trường này
                            }
                        } else if (rowData[index] instanceof Date) {
                            // Nếu giá trị là đối tượng Date
                            input.value = rowData[index].toISOString().split('T')[0];
                        } else {
                            console.warn('Unexpected date format:', rowData[index]);
                            input.value = ''; // Nếu không phải chuỗi hoặc Date, để trống trường này
                        }
                    } else {
                        input.value = rowData[index] || '';
                    }
                }
            });

            // Thêm một hàng mới vào bảng filteredPackingList với Mã kiện (NB)
            const newRow = document.createElement('tr');
            newRow.innerHTML = rowData.map((cell, index) => {
                if (pnkData[0][index] === 'Mã kiện (NB)') {
                    return `<td>${cell}</td>`;
                }
                return '<td></td>';
            }).join('') + '<td></td>'; // Cột cuối cùng cho nút xóa (trống trong trường hợp này)
            filteredPackingListBody.appendChild(newRow);

            // Hiển thị nút cập nhật và ẩn nút thêm mới
            document.getElementById('addPNKButton').style.display = 'none';
            document.getElementById('updatePNKButton').style.display = 'inline-block';

            // Lưu ID của dòng đang chỉnh sửa
            document.getElementById('editingRowId').value = rowIndex;

            console.log("Editing row:", rowData);
        }

        async function deletePNK(rowIndex) {
            // Kiểm tra xem rowIndex có phải là dòng tiêu đề hoặc dòng đầu tiên không
            if (rowIndex <= 2) {
                alert('Không thể xóa dòng tiêu đề hoặc dòng đầu tiên!');
                return;
            }

            if (confirm('Bạn có chắc chắn muốn xóa dòng này không?')) {
                showLoading(true);
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'deletePNK', row: rowIndex })
                    });
                    const result = await response.text();
                    console.log("Kết quả xóa:", result);

                    // Làm mới dữ liệu PNK
                    await refreshPNKData();
                    renderPNKTable();
                } catch (error) {
                    console.error("Lỗi khi xóa PNK:", error);
                    alert(`Lỗi: ${error.message}`);
                } finally {
                    showLoading(false);
                }
            }
        }
    </script>
</body>

</html>
