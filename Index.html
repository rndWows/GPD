<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Packing List và PNK</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .tab {
            display: none;
        }

        .tab.active {
            display: block;
        }

        .container {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" onclick="showTab('packingList')" href="#">Packing List</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="showTab('pnk')" href="#">PNK</a>
            </li>
        </ul>

        <div id="packingList" class="tab active">
            <h2>Packing List</h2>
            <table id="packingListTable" class="table table-striped table-bordered" style="width: 100%;">
                <thead>
                    <tr>
                        <th>TỜ KHAI</th>
                        <th>NGÀY TỜ KHAI</th>
                        <th>ĐƠN GIÁ (USD)</th>
                        <th>ĐƠN GIÁ (EUR)</th>
                        <th>TỶ GIÁ</th>
                        <th>FSC</th>
                        <th>XUẤT XỨ</th>
                        <th>INVOICE</th>
                        <th>TÊN NHÀ CUNG CẤP</th>
                        <th>SỐ CONTAINER</th>
                        <th>TÊN GỖ</th>
                        <th>MÃ KIỆN (dùng cho file nội bộ)</th>
                        <th>KHỐI LƯỢNG THỰC TẾ</th>
                        <th>SỐ THANH THỰC TẾ</th>
                        <th>CHIỀU DÀI THỰC TẾ</th>
                        <th>CHIỀU RỘNG THỰC TẾ</th>
                        <th>MÃ KIỆN TRÊN PL</th>
                        <th>Trạng thái kiện</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="pnk" class="tab">
            <h2>PNK</h2>
            <form id="pnkForm" class="mb-4">
                <div class="row">
                  <div class="col-md-3 mb-3">
                    <label for="nghiepVu" class="form-label">Nghiệp vụ:</label>
                    <div id="nghiepVu" class="btn-group d-flex flex-wrap" role="group">
                      <button type="button" class="btn btn-outline-primary" onclick="updateLocationFields('Nhập kho')">Nhập kho</button>
                      <button type="button" class="btn btn-outline-primary" onclick="updateLocationFields('Xuất kho')">Xuất kho</button>
                      <button type="button" class="btn btn-outline-primary" onclick="updateLocationFields('Chuyển kho')">Chuyển kho</button>
                      <button type="button" class="btn btn-outline-primary" onclick="updateLocationFields('Trả hàng')">Trả hàng</button>
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="soPhieu" class="form-label">Số phiếu:</label>
                    <input type="text" class="form-control" id="soPhieu" name="soPhieu" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="ngayThang" class="form-label">Ngày tháng:</label>
                    <input type="date" class="form-control" id="ngayThang" name="ngayThang" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="tuDau" class="form-label">Từ đâu:</label>
                    <input type="text" class="form-control" id="tuDau" name="tuDau" required>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-3 mb-3">
                    <label for="denDau" class="form-label">Đến đâu:</label>
                    <input type="text" class="form-control" id="denDau" name="denDau" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="dienGiai" class="form-label">Diễn giải:</label>
                    <input type="text" class="form-control" id="dienGiai" name="dienGiai" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="chungTuDiKem" class="form-label">Chứng từ đi kèm:</label>
                    <select class="form-select" id="chungTuDiKem" name="chungTuDiKem" required></select>
                  </div>
                  <div class="col-md-3 mb-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Thêm mới</button>
                  </div>
                </div>
              </form>

            <h3>Packing List cho INVOICE đã chọn</h3>
            <table id="selectedPackingListTable" class="table table-bordered" style="width: 100%;">
                <thead>
                    <tr>
                        <th>TỜ KHAI</th>
                        <th>NGÀY TỜ KHAI</th>
                        <th>ĐƠN GIÁ (USD)</th>
                        <th>ĐƠN GIÁ (EUR)</th>
                        <th>TỶ GIÁ</th>
                        <th>FSC</th>
                        <th>XUẤT XỨ</th>
                        <th>INVOICE</th>
                        <th>TÊN NHÀ CUNG CẤP</th>
                        <th>SỐ CONTAINER</th>
                        <th>TÊN GỖ</th>
                        <th>MÃ KIỆN (dùng cho file nội bộ)</th>
                        <th>KHỐI LƯỢNG THỰC TẾ</th>
                        <th>SỐ THANH THỰC TẾ</th>
                        <th>CHIỀU DÀI THỰC TẾ</th>
                        <th>CHIỀU RỘNG THỰC TẾ</th>
                        <th>MÃ KIỆN TRÊN PL</th>
                        <th>Trạng thái kiện</th>
                        <th>Chọn</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <h3>Danh sách PNK</h3>
            <button id="saveButton" onclick="savePNKData()" class="btn btn-success mb-2">Lưu dữ liệu PNK vào
                database</button>
            <table id="pnkTable" class="table table-striped table-bordered" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Nghiệp vụ</th>
                        <th>Số phiếu</th>
                        <th>Ngày tháng</th>
                        <th>Từ đâu</th>
                        <th>Đến đâu</th>
                        <th>Diễn giải</th>
                        <th>Chứng từ đi kèm</th>
                        <th>Mã kiện (NB)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let packingListData = [];
        let pnkData = [];
        let tempPNKData = [];

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        async function fetchData() {
            try {
                const packingListResponse = await fetch('https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec?action=getPackingList');
                packingListData = await packingListResponse.json();

                const pnkResponse = await fetch('https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec?action=getPNK');
                pnkData = await pnkResponse.json();

                initializePackingListTable();
                initializePNKForm();
                initializePNKTable();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function initializePackingListTable() {
            $('#packingListTable').DataTable({
                data: packingListData.slice(1),
                columns: packingListData[0].map(header => ({ title: header }))
            });
        }
        function updateLocationFields(nghiepVu) {
            const tuDau = document.getElementById('tuDau');
            const denDau = document.getElementById('denDau');

            if (nghiepVu === 'Nhập kho') {
                tuDau.value = 'Kho NCC';
                denDau.value = 'Kho An Phú';
            } else if (nghiepVu === 'Xuất kho') {
                tuDau.value = 'Kho An Phú';
                denDau.value = 'Kho Khách Hàng';
            } else if (nghiepVu === 'Chuyển kho') {
                tuDau.value = '';
                denDau.value = '';
            } else if (nghiepVu === 'Trả hàng') {
                tuDau.value = 'Kho Khách Hàng';
                denDau.value = 'Kho An Phú';
            } else {
                tuDau.value = '';
                denDau.value = '';
            }

            updateSoPhieu();
        }

        function updateSoPhieu() {
            const nghiepVuButtons = document.querySelectorAll('#nghiepVu .btn');
            let nghiepVu = '';
            nghiepVuButtons.forEach(button => {
                if (button.classList.contains('active')) {
                    nghiepVu = button.textContent.trim();
                }
            });

            const tuDau = document.getElementById('tuDau').value;
            const denDau = document.getElementById('denDau').value;
            const ngayThang = document.getElementById('ngayThang').value.replace(/-/g, '.');

            if (nghiepVu === 'Nhập kho') {
                document.getElementById('soPhieu').value = `PNK-${tuDau}-${denDau}-${ngayThang}`;
            } else if (nghiepVu === 'Xuất kho') {
                document.getElementById('soPhieu').value = `PXK-${tuDau}-${denDau}-${ngayThang}`;
            } else if (nghiepVu === 'Chuyển kho') {
                document.getElementById('soPhieu').value = `PCK-${tuDau}-${denDau}-${ngayThang}`;
            } else if (nghiepVu === 'Trả hàng') {
                document.getElementById('soPhieu').value = `PTH-${tuDau}-${denDau}-${ngayThang}`;
            }
        }

        document.getElementById('tuDau').addEventListener('change', updateSoPhieu);
        document.getElementById('denDau').addEventListener('change', updateSoPhieu);
        document.getElementById('ngayThang').addEventListener('change', updateSoPhieu);
        function initializePNKForm() {
            const invoices = [...new Set(packingListData.slice(1).map(row => row[7]))];
            const select = document.getElementById('chungTuDiKem');
            invoices.forEach(invoice => {
                const option = document.createElement('option');
                option.value = option.textContent = invoice;
                select.appendChild(option);
            });

            select.addEventListener('change', updateSelectedPackingList);
            document.getElementById('pnkForm').addEventListener('submit', handlePNKSubmit);
        }

        function updateSelectedPackingList() {
            const selectedInvoice = document.getElementById('chungTuDiKem').value;
            const filteredData = packingListData.slice(1).filter(row => row[7] === selectedInvoice);
            $('#selectedPackingListTable').DataTable({
                data: filteredData,
                columns: packingListData[0].map(header => ({ title: header })).concat([
                    {
                        title: 'Chọn',
                        render: function (data, type, row) {
                            return '<input type="checkbox" value="' + row[11] + '" checked>';
                        }
                    }
                ]),
                destroy: true
            });
        }

        function handlePNKSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedMaKiens = Array.from(document.querySelectorAll('#selectedPackingListTable input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);

            const newPNKData = selectedMaKiens.map(maKien => [
                formData.get('nghiepVu'),
                formData.get('soPhieu'),
                formData.get('ngayThang'),
                formData.get('tuDau'),
                formData.get('denDau'),
                formData.get('dienGiai'),
                formData.get('chungTuDiKem'),
                maKien
            ]);

            tempPNKData = tempPNKData.concat(newPNKData);
            updatePNKTable();
            document.getElementById('saveButton').style.display = 'block';
        }

        function updatePNKTable() {
            const table = $('#pnkTable').DataTable();
            table.clear();
            table.rows.add(pnkData.concat(tempPNKData));
            table.draw();
        }

        async function savePNKData() {
            try {
                const dataToSend = {
                    action: 'addPNK',
                    data: tempPNKData.map(row => ({
                        'Nghiệp vụ': row[0],
                        'Số phiếu': row[1],
                        'Ngày tháng': row[2],
                        'Từ đâu': row[3],
                        'Đến đâu': row[4],
                        'Diễn giải': row[5],
                        'Chứng từ đi kèm': row[6],
                        'Mã kiện (NB)': row[7]
                    }))
                };

                const response = await fetch('https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec', {
                    method: 'POST',
                    body: JSON.stringify(dataToSend)
                });

                const responseText = await response.text();

                if (response.ok) {
                    const result = JSON.parse(responseText);
                    pnkData = pnkData.concat(tempPNKData);
                    tempPNKData = [];
                    updatePNKTable();
                    document.getElementById('saveButton').style.display = 'none';
                } else {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error('Error saving PNK data:', error);
                alert('Đã xảy ra lỗi khi lưu dữ liệu: ' + error.message);
            }
        }

        function initializePNKTable() {
            $('#pnkTable').DataTable({
                data: pnkData,
                columns: [
                    { data: 0, title: "Nghiệp vụ" },
                    { data: 1, title: "Số phiếu" },
                    { data: 2, title: "Ngày tháng" },
                    { data: 3, title: "Từ đâu" },
                    { data: 4, title: "Đến đâu" },
                    { data: 5, title: "Diễn giải" },
                    { data: 6, title: "Chứng từ đi kèm" },
                    { data: 7, title: "Mã kiện (NB)" },

                ]
            });
        }

        function deletePNKRow(rowIndex) {
            if (confirm("Bạn có chắc chắn muốn xóa dòng này?")) {
                const table = $('#pnkTable').DataTable();
                const rowData = table.row(rowIndex).data();
                const rowToDelete = pnkData.findIndex(row => row.every((value, index) => value === rowData[index]));

                if (rowToDelete !== -1) {
                    deletePNK(rowToDelete + 2) // +2 vì hàng đầu tiên là tiêu đề và chỉ số bắt đầu từ 1 trong Google Sheets
                        .then(() => {
                            pnkData.splice(rowToDelete, 1);
                            table.row(rowIndex).remove().draw();
                        })
                        .catch(error => {
                            console.error('Error deleting PNK row:', error);
                            alert('Đã xảy ra lỗi khi xóa dòng: ' + error.message);
                        });
                }
            }
        }

        async function deletePNK(row) {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec', {
                    method: 'POST',

                    body: `action=deletePNK&row=${row}`
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                console.log(result.message);
            } catch (error) {
                console.error('Error deleting PNK row:', error);
                throw error; // Re-throw the error so it can be caught in deletePNKRow
            }
        }

        fetchData();
        showTab('packingList');
    </script>
</body>

</html>