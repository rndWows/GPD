<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Packing List và PNK</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="fui-toast"></div>
    <div id="loading-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
    </div>
    <nav class="sticky-top bg-white">
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#packingList">Packing List</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#pnk">PNK</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#inventory">Tồn kho</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#inventoryReport">Báo cáo tồn kho</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#userGuide">Hướng dẫn sử dụng</a>
            </li>
        </ul>

    </nav>
    <div class="tab-content mt-4">
        <div class="tab-pane fade show active" id="packingList">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2><i class="fas fa-list"></i> Packing List</h2>
                </div>
                <div class="card-body">
                    <table id="packingListTable" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>TỜ KHAI</th>
                                <th>NGÀY TỜ KHAI</th>
                                <th>ĐƠN GIÁ (USD)</th>
                                <th>ĐƠN GIÁ (EUR)</th>
                                <th>TỶ GIÁ</th>
                                <th>FSC</th>
                                <th>XUẤT XỨ</th>
                                <th>INVOICE</th>
                                <th>TÊN NHÀ CUNG CẤP</th>
                                <th>SỐ CONTAINER</th>
                                <th>TÊN GỖ</th>
                                <th>MÃ KIỆN (dùng cho file nội bộ)</th>
                                <th>KHỐI LƯỢNG THỰC TẾ</th>
                                <th>SỐ THANH THỰC TẾ</th>
                                <th>CHIỀU DÀI THỰC TẾ</th>
                                <th>CHIỀU RỘNG THỰC TẾ</th>
                                <th>MÃ KIỆN TRÊN PL</th>
                                <th>Trạng thái kiện</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="inventory">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h2><i class="fas fa-warehouse"></i> Tồn kho</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tenGoSearch" class="form-label">Tìm kiếm theo Tên Gỗ:</label>
                            <select id="tenGoSearch" class="form-control select2-search"></select>
                        </div>
                        <div class="col-md-6">
                            <label for="maKienSearch" class="form-label">Tìm kiếm theo Mã Kiện:</label>
                            <select id="maKienSearch" class="form-control select2-search"></select>
                        </div>
                    </div>
                    <table id="inventoryTable" class="table table-hover table-bordered" style="width: 100%;">
                        <!-- ... -->
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pnk">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h2><i class="fas fa-file-invoice"></i> PNK</h2>
                </div>
                <div class="card-body">

                    <form id="pnkForm" class="mb-4">
                        <div class="row">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="nghiepVu" class="form-label">Loại nghiệp vụ:</label>
                                    <select class="form-select" id="nghiepVu" name="nghiepVu"
                                        onchange="updateLocationFields()" required>
                                        <optgroup label="Nhập kho">
                                            <option value="Nhập Mua Hàng">Nhập mua hàng</option>
                                            <option value="Nhập Trả Hàng">Nhập trả hàng</option>
                                            <option value="Nhập Tạm">Nhập tạm</option>
                                            <option value="Nhập Chuển Kho">Nhập chuyển kho</option>
                                        </optgroup>
                                        <optgroup label="Xuất kho">
                                            <option value="Xuất Bán">Xuất bán</option>
                                            <option value="Xuất Tạm">Xuất tạm</option>
                                            <option value="Xuất Chuyển Kho">Xuất chuyển kho</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="soPhieu" class="form-label">Số phiếu:</label>
                                    <input type="text" class="form-control" id="soPhieu" name="soPhieu" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="ngayThang" class="form-label">Ngày tháng:</label>
                                    <input type="date" class="form-control" id="ngayThang" name="ngayThang" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="tuDau" class="form-label">Từ kho:</label>
                                    <select class="form-select" id="tuDau" name="tuDau" required>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="denDau" class="form-label">Đến kho:</label>
                                    <select class="form-select" id="denDau" name="denDau" required>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="col-md-9 mb-3">
                                    <label for="dienGiai" class="form-label">Diễn giải:</label>
                                    <input type="text" class="form-control" id="dienGiai" name="dienGiai" required>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="chungTuDiKem" class="form-label">Chứng từ đi kèm:</label>
                                <select class="form-select" id="chungTuDiKem" name="chungTuDiKem" required></select>
                            </div>
                            <div class="col-md-3 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Thêm mới</button>
                            </div>
                        </div>
                    </form>

                    <h3>Packing List cho INVOICE đã chọn</h3>
                    <table id="selectedPackingListTable" class="fui-table-ui-basic-linh table-wrap"
                        style="width: 100%;">
                        <thead>
                            <tr>
                                <th>TỜ KHAI</th>
                                <th>NGÀY TỜ KHAI</th>
                                <th>ĐƠN GIÁ (USD)</th>
                                <th>ĐƠN GIÁ (EUR)</th>
                                <th>TỶ GIÁ</th>
                                <th>FSC</th>
                                <th>XUẤT XỨ</th>
                                <th>INVOICE</th>
                                <th>TÊN NHÀ CUNG CẤP</th>
                                <th>SỐ CONTAINER</th>
                                <th>TÊN GỖ</th>
                                <th>MÃ KIỆN</th>
                                <th>KHỐI LƯỢNG THỰC TẾ</th>
                                <th>SỐ THANH THỰC TẾ</th>
                                <th>CHIỀU DÀI THỰC TẾ</th>
                                <th>CHIỀU RỘNG THỰC TẾ</th>
                                <th>MÃ KIỆN TRÊN PL</th>
                                <th>Trạng thái kiện</th>
                                <th>Chọn</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h3>Danh sách PNK</h3>
                    <button id="saveButton" onclick="savePNKData()" class="btn btn-success mb-2">Lưu dữ liệu PNK vào
                        database</button>
                    <table id="pnkTable" class="fui-table-ui-basic-linh table-wrap" style="width: 100%;">
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>
        <div class="tab-pane fade" id="inventoryReport">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h2><i class="fas fa-chart-bar"></i> Báo cáo tồn kho</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="dateRange" class="form-label">Khoảng thời gian:</label>
                            <input type="text" id="dateRange" class="form-control" />
                        </div>
                        <div class="col-md-4">
                            <label for="tenGoFilter" class="form-label">Tên Gỗ:</label>
                            <select id="tenGoFilter" class="form-control select2-search"></select>
                        </div>
                        <div class="col-md-4">
                            <label for="maKienFilter" class="form-label">Mã Kiện:</label>
                            <select id="maKienFilter" class="form-control select2-search"></select>
                        </div>
                    </div>
                    <table id="inventoryReportTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Tên Gỗ</th>
                                <th>Nhập</th>
                                <th>Xuất</th>
                                <th>Tồn</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="userGuide">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h2><i class="fas fa-book"></i> Hướng dẫn sử dụng</h2>
                </div>
                <div class="card-body">
                    <h3>1. Tab Packing List</h3>
                    <p>Hiển thị danh sách Packing List. Bạn có thể xem và tìm kiếm thông tin về các kiện hàng.</p>

                    <h3>2. Tab PNK (Phiếu Nhập Kho)</h3>
                    <p>Cho phép bạn tạo và quản lý các phiếu nhập kho:</p>
                    <ul>
                        <li>Chọn loại nghiệp vụ, điền thông tin phiếu.</li>
                        <li>Chọn chứng từ đi kèm (Invoice) để lọc danh sách Packing List.</li>
                        <li>Chọn các kiện hàng cần nhập kho.</li>
                        <li>Nhấn "Thêm mới" để tạo phiếu nhập kho mới.</li>
                        <li>Nhấn "Lưu dữ liệu PNK vào database" để lưu các phiếu đã tạo.</li>
                    </ul>

                    <h3>3. Tab Tồn kho</h3>
                    <p>Hiển thị thông tin tồn kho kết hợp từ Packing List và PNK:</p>
                    <ul>
                        <li>Sử dụng các bộ lọc để tìm kiếm theo Tên Gỗ hoặc Mã Kiện.</li>
                        <li>Xem thông tin chi tiết về từng kiện hàng và trạng thái tồn kho.</li>
                    </ul>

                    <h3>Lưu ý chung:</h3>
                    <ul>
                        <li>Đảm bảo kết nối internet ổn định để tải và lưu dữ liệu.</li>
                        <li>Kiểm tra kỹ thông tin trước khi thêm mới hoặc lưu dữ liệu.</li>
                        <li>Nếu gặp lỗi, hãy làm mới trang và thử lại.</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
    <script>
        let packingListData = [], pnkData = [], tempPNKData = [];
        let inventoryTable;
        const showTab = (tabName) => {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'inventory') {
                $('#inventoryTable').DataTable().destroy();
                initializeInventoryTable();
            }
        };

        const fetchData = async () => {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                const [packingListResponse, pnkResponse] = await Promise.all([
                    fetch('https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec?action=getPackingList'),
                    fetch('https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec?action=getPNK')
                ]);

                if (!packingListResponse.ok || !pnkResponse.ok) {
                    throw new Error('Network response was not ok');
                }

                packingListData = await packingListResponse.json();
                pnkData = await pnkResponse.json();

                console.log('Fetched data:', { packingListData, pnkData }); // Thêm dòng này để kiểm tra dữ liệu

                initializePackingListTable();
                initializePNKForm();
                initializePNKTable();
                FuiToast.success('Tải thành công.');
            } catch (error) {
                console.error('Error fetching data:', error);
                FuiToast.error('Lỗi tìm nạp dữ liệu: ' + error.message);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        };

        const initializePackingListTable = () => {
            $('#packingListTable').DataTable({
                data: packingListData.slice(1),
                columns: packingListData[0].map(header => ({ title: header }))
            });
        };

        const updateLocationFields = () => {
            const nghiepVu = document.getElementById('nghiepVu').value;
            const tuKho = document.getElementById('tuDau');
            const denKho = document.getElementById('denDau');
            const soPhieuInput = document.getElementById('soPhieu');

            tuKho.innerHTML = '';
            denKho.innerHTML = '';

            const options = {
                'Nhập Mua Hàng': [['Kho Nhà Cung Cấp', 'Kho Nhà Cung Cấp'], ['Kho An Phú', 'Kho An Phú', true], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm']],
                'Nhập Trả Hàng': [['Kho khách hàng', 'Kho Khách Hàng'], ['Kho An Phú', 'Kho An Phú', true], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm']],
                'Nhập Tạm': [['Kho Nhà Cung Cấp', 'Kho Nhà Cung Cấp'], ['Kho An Phú', 'Kho An Phú', true], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm']],
                'Nhập Chuển Kho': [['Kho Hoàng Lâm', 'Kho Hoàng Lâm', true], ['Kho An Phú', 'Kho An Phú'], ['Kho An Phú', 'Kho An Phú', true], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm']],
                'Xuất Bán': [['Kho An Phú', 'Kho An Phú', true], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm'], ['Kho khách hàng', 'Kho Khách Hàng']],
                'Xuất Tạm': [['Kho An Phú', 'Kho An Phú', true], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm'], ['Kho Nhà Cung Cấp', 'Kho Nhà Cung Cấp']],
                'Xuất Chuyển Kho': [['Kho An Phú', 'Kho An Phú', true], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm'], ['Kho Hoàng Lâm', 'Kho Hoàng Lâm', true], ['Kho An Phú', 'Kho An Phú']]
            };

            (options[nghiepVu] || []).forEach((opt, index) => {
                const [text, value, selected] = opt;
                const target = index < 2 ? tuKho : denKho;
                addOption(target, text, value, selected);
            });

            soPhieuInput.value = generateSoPhieu(nghiepVu, tuKho.value, denKho.value);
        };

        const addOption = (selectElement, text, value, selected = false) => {
            const option = new Option(text, value, selected, selected);
            selectElement.add(option);
        };

        const generateSoPhieu = (nghiepVu, tuDau, denDau) => {
            const prefixMap = {
                'Nhập Mua Hàng': 'NMH', 'Nhập Trả Hàng': 'NTH', 'Nhập Tạm': 'NTA',
                'Nhập Chuển Kho': 'NCK', 'Xuất Bán': 'XBA', 'Xuất Tạm': 'XTA', 'Xuất Chuyển Kho': 'XCK'
            };
            const locationMap = {
                'Kho Nhà Cung Cấp': 'NC', 'Kho An Phú': 'AP', 'Kho Hoàng Lâm': 'HL', 'Kho Khách Hàng': 'KH'
            };
            const prefix = prefixMap[nghiepVu] || 'XXX';
            const from = locationMap[tuDau] || 'XX';
            const to = locationMap[denDau] || 'XX';
            const date = new Date();
            const dateStr = `${date.getDate().toString().padStart(2, '0')}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getFullYear().toString().slice(-2)}`;
            return `${prefix}-${from}-${to}-${dateStr}-001`;
        };

        const initializePNKForm = () => {
            const invoices = [...new Set(packingListData.slice(1).map(row => row[7]))];
            const select = document.getElementById('chungTuDiKem');
            invoices.forEach(invoice => {
                const option = document.createElement('option');
                option.value = option.textContent = invoice;
                select.appendChild(option);
            });
            select.addEventListener('change', updateSelectedPackingList);
            document.getElementById('pnkForm').addEventListener('submit', handlePNKSubmit);

        };

        const updateSelectedPackingList = () => {
            const selectedInvoice = document.getElementById('chungTuDiKem').value;
            const filteredData = packingListData.slice(1).filter(row => row[7] === selectedInvoice);
            $('#selectedPackingListTable').DataTable({
                data: filteredData,
                columns: [...packingListData[0].map(header => ({ title: header })),
                {
                    title: 'Chọn',
                    render: (data, type, row) => ` <label class="fui-checkbox-toggle">
      <input type="checkbox" id="toggle-input" class="toggle-input"  value="${row[11]}" checked />
      <div class="toggle-bar">
        <div class="toggle-spin"></div>
      </div>
    </label>
                    `
                }],
                destroy: true
            });
        };

        const handlePNKSubmit = (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedMaKiens = Array.from(document.querySelectorAll('#selectedPackingListTable input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            const newPNKData = selectedMaKiens.map(maKien => [
                formData.get('nghiepVu'), formData.get('soPhieu'), formData.get('ngayThang'),
                formData.get('tuDau'), formData.get('denDau'), formData.get('dienGiai'),
                formData.get('chungTuDiKem'), maKien
            ]);
            tempPNKData = tempPNKData.concat(newPNKData);
            updatePNKTable();

            document.getElementById('saveButton').style.display = 'block';
        };

        const updatePNKTable = () => {
            const table = $('#pnkTable').DataTable();
            table.clear();
            table.rows.add(pnkData.concat(tempPNKData));
            table.draw();
            FuiToast.info('Đữ liệu mới thêm vào bộ nhớ tạm chưa lưu vào datas')
        };

        const savePNKData = async () => {
            try {
                const dataToSend = {
                    action: 'addPNK',
                    data: tempPNKData.map(row => ({
                        'Nghiệp vụ': row[0], 'Số phiếu': row[1], 'Ngày tháng': row[2],
                        'Từ đâu': row[3], 'Đến đâu': row[4], 'Diễn giải': row[5],
                        'Chứng từ đi kèm': row[6], 'Mã kiện (NB)': row[7]
                    }))
                };
                const response = await fetch('https://script.google.com/macros/s/AKfycbx4cpvJhB21RYDPWWJP65ecAdx1vB05oF7-ZK7pRLK4fgofV5-LcRQwyUS-wa-M99w3/exec', {
                    method: 'POST',
                    body: JSON.stringify(dataToSend)
                });
                if (response.ok) {
                    const result = await response.json();
                    pnkData = pnkData.concat(tempPNKData);       
                    tempPNKData = [];
                    updatePNKTable();
                    document.getElementById('saveButton').style.display = 'none';
                    FuiToast.success('Đã tải dữ liệu thành công')
                } else {
                    FuiToast.error('Mạng bị lỗi.')
                }
            } catch (error) {
                FuiToast.error('Lỗi không lưu được data lên sever liên hệ admin.')
            }
        };





        const initializePNKTable = () => {
            $('#pnkTable').DataTable({
                data: pnkData.slice(1),
                columns: pnkData[0].map(header => ({ title: header })),
                ordering: true,
                searching: true
            });
        };

        function initializeInventoryTable() {
            if ($.fn.DataTable.isDataTable('#inventoryTable')) {
                inventoryTable.ajax.reload();
                return;
            }

            const inventoryData = combinePackingListAndPNK();

            inventoryTable = $('#inventoryTable').DataTable({
                data: inventoryData,
                columns: [
                    { title: "Nghiệp vụ", data: "nghiepVu" },
                    { title: "Số phiếu", data: "soPhieu" },
                    { title: "Ngày tháng", data: "ngayThang" },
                    { title: "Từ đâu", data: "tuDau" },
                    { title: "Đến đâu", data: "denDau" },
                    { title: "Diễn giải", data: "dienGiai" },
                    { title: "Chứng từ đi kèm", data: "chungTuDiKem" },
                    { title: "Mã kiện (NB)", data: "maKienNB" },
                    { title: "TỜ KHAI", data: "toKhai" },
                    { title: "NGÀY TỜ KHAI", data: "ngayToKhai" },
                    { title: "ĐƠN GIÁ (USD)", data: "donGiaUSD" },
                    { title: "ĐƠN GIÁ (EUR)", data: "donGiaEUR" },
                    { title: "TỶ GIÁ", data: "tyGia" },
                    { title: "FSC", data: "fsc" },
                    { title: "XUẤT XỨ", data: "xuatXu" },
                    { title: "INVOICE", data: "invoice" },
                    { title: "TÊN NHÀ CUNG CẤP", data: "tenNhaCungCap" },
                    { title: "SỐ CONTAINER", data: "soContainer" },
                    { title: "TÊN GỖ", data: "tenGo" },
                    { title: "MÃ KIỆN", data: "maKien" },
                    { title: "KHỐI LƯỢNG THỰC TẾ", data: "khoiLuongThucTe" },
                    { title: "SỐ THANH THỰC TẾ", data: "soThanhThucTe" },
                    { title: "CHIỀU DÀI THỰC TẾ", data: "chieuDaiThucTe" },
                    { title: "CHIỀU RỘNG THỰC TẾ", data: "chieuRongThucTe" },
                    { title: "MÃ KIỆN TRÊN PL", data: "maKienTrenPL" },
                    { title: "Trạng thái kiện", data: "trangThaiKien" }
                ],
                pageLength: 10,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                scrollX: true,
                scrollY: '50vh',
                scrollCollapse: true,
                fixedColumns: { left: 7 },
                dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"p>>',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
                responsive: {
                    details: {
                        type: 'column',
                        target: 'tr'
                    }
                },
                columnDefs: [
                    {
                        className: 'control',
                        orderable: false,
                        targets: 0
                    },
                    {
                        targets: '_all',
                        defaultContent: ""
                    }
                ],
                order: [[1, 'asc']],
                deferRender: true,
                initComplete: function (settings, json) {
                    updateFilters(inventoryData);
                }
            });
        }

        function updateFilters(data) {
            $('#tenGoSearch').select2({
                data: [...new Set(data.map(item => item.tenGo))].map(tenGo => ({ id: tenGo, text: tenGo })),
                placeholder: 'Chọn Tên Gỗ',
                allowClear: true
            }).on('change', function () {
                inventoryTable.column(18).search($(this).val()).draw();
            });

            $('#maKienSearch').select2({
                data: [...new Set(data.map(item => item.maKien))].map(maKien => ({ id: maKien, text: maKien })),
                placeholder: 'Chọn Mã Kiện',
                allowClear: true
            }).on('change', function () {
                inventoryTable.column(19).search($(this).val()).draw();
            });
        }
        $('a[data-bs-toggle="tab"][href="#inventory"]').on('shown.bs.tab', function (e) {
            document.getElementById('loading-overlay').style.display = 'flex';
            setTimeout(() => {
                initializeInventoryTable();
                document.getElementById('loading-overlay').style.display = 'none';
            }, 100);
        });
        const combinePackingListAndPNK = () => {
            const packingListMap = new Map(packingListData.slice(1).map(row => [
                row[11],
                {
                    toKhai: row[0], ngayToKhai: row[1], donGiaUSD: row[2], donGiaEUR: row[3],
                    tyGia: row[4], fsc: row[5], xuatXu: row[6], invoice: row[7],
                    tenNhaCungCap: row[8], soContainer: row[9], tenGo: row[10], maKien: row[11],
                    khoiLuongThucTe: row[12], soThanhThucTe: row[13], chieuDaiThucTe: row[14],
                    chieuRongThucTe: row[15], maKienTrenPL: row[16], trangThaiKien: row[17]
                }
            ]));

            const result = pnkData.reduce((acc, row) => {
                const packingListInfo = packingListMap.get(row[7]);
                if (packingListInfo) {
                    acc.push({
                        nghiepVu: row[0], soPhieu: row[1], ngayThang: row[2], tuDau: row[3],
                        denDau: row[4], dienGiai: row[5], chungTuDiKem: row[6], maKienNB: row[7],
                        ...packingListInfo
                    });
                }
                return acc;
            }, []);

            console.log('Combined data:', result); // Thêm dòng này để kiểm tra dữ liệu
            return result;
        };

        document.addEventListener('DOMContentLoaded', function () {
            const triggerTabList = [].slice.call(document.querySelectorAll('.nav-tabs a'));
            triggerTabList.forEach(function (triggerEl) {
                const tabTrigger = new bootstrap.Tab(triggerEl);
                triggerEl.addEventListener('click', function (event) {
                    event.preventDefault();
                    tabTrigger.show();
                });
            });

            const tabElList = [].slice.call(document.querySelectorAll('a[data-bs-toggle="tab"]'));
            tabElList.forEach(function (tabEl) {
                tabEl.addEventListener('show.bs.tab', function (event) {
                    const targetId = event.target.getAttribute('href').slice(1);
                    if (targetId === 'inventory') {
                        document.getElementById('loading-overlay').style.display = 'flex';
                    }
                });

                tabEl.addEventListener('shown.bs.tab', function (event) {
                    const targetId = event.target.getAttribute('href').slice(1);
                    if (targetId === 'inventory') {
                        if ($.fn.DataTable.isDataTable('#inventoryTable')) {
                            $('#inventoryTable').DataTable().destroy();
                        }
                        initializeInventoryTable();
                        document.getElementById('loading-overlay').style.display = 'none';
                    }
                });
            });

            document.getElementById('ngayThang').valueAsDate = new Date();
            updateLocationFields();

        });

        window.addEventListener('scroll', function () {
            const nav = document.querySelector('.sticky-top');
            if (window.scrollY > 50) {
                nav.classList.add('scrolled');
            } else {
                nav.classList.remove('scrolled');
            }
        });

        function initializeInventoryReport() {
            const inventoryData = combinePackingListAndPNK();
            const reportData = processInventoryData(inventoryData);

            const table = $('#inventoryReportTable').DataTable({
                data: reportData,
                columns: [
                    {
                        className: 'dt-control',
                        orderable: false,
                        data: null,
                        defaultContent: '',
                    },
                    { data: 'tenGo' },
                    { data: 'nhap', render: $.fn.dataTable.render.number(',', '.', 2) },
                    { data: 'xuat', render: $.fn.dataTable.render.number(',', '.', 2) },
                    { data: 'ton', render: $.fn.dataTable.render.number(',', '.', 2) }
                ],
                order: [[1, 'asc']],
                pageLength: 25,
                dom: 'Bfrtip',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });

            // Xử lý sự kiện click để hiển thị/ẩn chi tiết
            $('#inventoryReportTable tbody').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });

            // Xử lý tìm kiếm
            $('#dateRange').daterangepicker({
                opens: 'left'
            }, function (start, end, label) {
                table.draw();
            });

            $('#tenGoFilter, #maKienFilter').select2({
                data: getUniqueValues(inventoryData, ['tenGo', 'maKienNB']),
                placeholder: 'Chọn giá trị',
                allowClear: true
            }).on('change', function () {
                table.draw();
            });

            // Custom filtering function
            $.fn.dataTable.ext.search.push(
                function (settings, data, dataIndex) {
                    const dateRange = $('#dateRange').val().split(' - ');
                    const startDate = moment(dateRange[0], 'MM/DD/YYYY');
                    const endDate = moment(dateRange[1], 'MM/DD/YYYY');
                    const date = moment(data[2], 'YYYY-MM-DD');

                    const tenGo = $('#tenGoFilter').val();
                    const maKien = $('#maKienFilter').val();

                    if (
                        (date.isBetween(startDate, endDate, null, '[]') || $('#dateRange').val() === '') &&
                        (tenGo === data[0] || tenGo === null) &&
                        (maKien === data[1] || maKien === null)
                    ) {
                        return true;
                    }
                    return false;
                }
            );
        }
        function format(d) {
            let detailTable = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
            detailTable += '<tr><th>Mã Kiện</th><th>Nhập</th><th>Xuất</th><th>Tồn</th></tr>';

            d.details.forEach(detail => {
                detailTable += '<tr>' +
                    '<td>' + detail.maKienNB + '</td>' +
                    '<td>' + detail.nhap.toFixed(2) + '</td>' +
                    '<td>' + detail.xuat.toFixed(2) + '</td>' +
                    '<td>' + detail.ton.toFixed(2) + '</td>' +
                    '</tr>';
            });

            detailTable += '</table>';
            return detailTable;
        }
        function processInventoryData(data) {
            const inventory = {};
            const nhapOperations = ['Nhập Mua Hàng', 'Nhập Trả Hàng', 'Nhập Tạm', 'Nhập Chuển Kho'];
            const xuatOperations = ['Xuất Bán', 'Xuất Tạm', 'Xuất Chuyển Kho'];

            data.forEach(item => {
                if (!inventory[item.tenGo]) {
                    inventory[item.tenGo] = { tenGo: item.tenGo, nhap: 0, xuat: 0, details: {} };
                }
                if (!inventory[item.tenGo].details[item.maKienNB]) {
                    inventory[item.tenGo].details[item.maKienNB] = { maKienNB: item.maKienNB, nhap: 0, xuat: 0 };
                }

                const quantity = parseFloat(item.khoiLuongThucTe) || 0;

                if (nhapOperations.includes(item.nghiepVu)) {
                    inventory[item.tenGo].nhap += quantity;
                    inventory[item.tenGo].details[item.maKienNB].nhap += quantity;
                } else if (xuatOperations.includes(item.nghiepVu)) {
                    inventory[item.tenGo].xuat += quantity;
                    inventory[item.tenGo].details[item.maKienNB].xuat += quantity;
                }
            });

            return Object.values(inventory).map(item => ({
                ...item,
                ton: item.nhap - item.xuat,
                details: Object.values(item.details).map(detail => ({
                    ...detail,
                    ton: detail.nhap - detail.xuat
                }))
            }));
        }

        function getUniqueValues(data, keys) {
            const uniqueValues = {};
            keys.forEach(key => {
                uniqueValues[key] = [...new Set(data.map(item => item[key]))];
            });
            return uniqueValues;
        }

        // Gọi hàm khởi tạo khi tab được hiển thị
        $('a[data-bs-toggle="tab"][href="#inventoryReport"]').on('shown.bs.tab', function (e) {
            if (!$.fn.DataTable.isDataTable('#inventoryReportTable')) {
                initializeInventoryReport();
            }
        });




        fetchData();
        showTab('packingList');

        document.getElementById('tuDau').addEventListener('change', updateSoPhieu);
        document.getElementById('denDau').addEventListener('change', updateSoPhieu);

        function updateSoPhieu() {
            const nghiepVu = document.getElementById('nghiepVu').value;
            const tuKho = document.getElementById('tuDau').value;
            const denKho = document.getElementById('denDau').value;
            const soPhieuInput = document.getElementById('soPhieu');
            soPhieuInput.value = generateSoPhieu(nghiepVu, tuKho, denKho);
        }
    </script>
</body>

</html>